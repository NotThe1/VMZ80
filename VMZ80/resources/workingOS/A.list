0001: 0100         ; A.Z80
0002: 0100         ; 8
0003: 0100             BDOS       EQU    00005H
0004: 0100             OPEN_FILE  EQU    0FH
0005: 0100             CLOSE_FILE EQU    10H
0006: 0100             FIND_FIRST EQU    11H
0007: 0100             FIND_NEXT  EQU    12H
0008: 0100             READ_SEQ   EQU    14H
0009: 0100             RENAME_FILE EQU    17H
0010: 0100             SET_DMA    EQU    1AH
0011: 0100             GET_SIZE   EQU    023H
0012: 0100             SET_RANDREC EQU    024H
0013: 0100             defaultBuffer EQU    080H
0014: 0100
0015: 0100             recordRandom EQU    20 + 1               ; Random record field (2 bytes)
0016: 0100             recordRandomLSB EQU    recordRandom         ; LSB of Random Record
0017: 0100             recordRandomMSB EQU    recordRandom + 1     ; MSB of Random Record
0018: 0100             recordRandomOVF EQU    recordRandom + 2     ; Random Record Overflow
0019: 0100
0020: 0100             TPA        EQU    0100H
0021: 0100
0022: 0100                        ORG    TPA
0023: 0100             Start:
0024: 0100 31 0A 03               LD     SP,Stack
0025: 0103 DD 21 39 01               LD     IX,CMD
0026: 0107 21 3E 01               LD     HL,builtInCMDNames
0027: 010A 11 04 00               LD     DE,builtInCMDNameSize
0028: 010D 06 06                  LD     B,builtInCMDCount
0029: 010F 0E 00                  LD     C,0
0030: 0111             Loop1:
0031: 0111 DD 7E 00               LD     A,(IX+0)
0032: 0114 BE                     CP     M
0033: 0115 28 06                  JR     Z,Match
0034: 0117 0C                     INC    C
0035: 0118 19                     ADD    HL,DE                ; point at next entry
0036: 0119 10 F6                  DJNZ   Loop1
0037: 011B 18 0F                  JR     UserCommand
0038: 011D         ;
0039: 011D             Match:
0040: 011D D5                     PUSH   DE                   ; Size of Match
0041: 011E 59                     LD     E,C                  ; Index into E
0042: 011F C1                     POP    BC                   ; Size of Match
0043: 0120             Loop2:
0044: 0120 DD 7E 00               LD     A,(IX+0)
0045: 0123 ED A1                  CPI
0046: 0125 DD 23                  INC    IX
0047: 0127 E2 2E 01               JP     PO,Found
0048: 012A 28 F4                  JR     Z,Loop2              ; if more loop
0049: 012C
0050: 012C             UserCommand:
0051: 012C 00                     NOP
0052: 012D 76                     HALT
0053: 012E
0054: 012E             Found:
0055: 012E DD 23                  INC    IX
0056: 0130 DD 7E 00               LD     A,(IX+0)
0057: 0133 FE 20                  CP     020H
0058: 0135 20 F5                  JR     NZ,UserCommand
0059: 0137 00                     NOP
0060: 0138 76                     HALT
0061: 0139
0062: 0139 53 41 56 45 20     CMD:       DB     'SAVE '
0063: 013E
0064: 013E         ;---------------------------------------------------
0065: 013E             builtInCMDNameSize EQU    04                   ; Size of intrinsic function names  ;
0066: 013E         ;
0067: 013E             builtInCMDNames:                      ;
0068: 013E 44 49 52 20                DB     'DIR '               ;
0069: 0142 45 52 41 20                DB     'ERA '               ;
0070: 0146 54 59 50 45                DB     'TYPE'               ;
0071: 014A 53 41 56 45                DB     'SAVE'               ;
0072: 014E 52 45 4E 20                DB     'REN '               ;
0073: 0152 55 53 45 52                DB     'USER'               ;
0074: 0156             builtInCMDCount EQU    (($-builtInCMDNames)/builtInCMDNameSize) + 1 ;
0075: 0156         ;
0076: 0156             builtInCMDVector:                      ;
0077: 0156 01 10                  DW     1001H                ; Directory List                    ;
0078: 0158 02 20                  DW     2002H                ; File erase                        ;
0079: 015A 03 30                  DW     3003H                ; Type file on Console              ;
0080: 015C 04 40                  DW     4004H                ; Save memory image                 ;
0081: 015E 00 05                  DW     500H                 ; File rename                       ;
0082: 0160 06 60                  DW     6006H                ; User number                       ;
0083: 0162 07 70                  DW     7007H                ; User-defined function             ;
0084: 0164         ;----------------------------------------------------------------------------
0085: 0164             FCB:
0086: 0164
0087: 0164 00          DISK:      DB     00
0088: 0165 42 20 20 20 20 20 20 20     NAME:      DB     'B       '
0089: 016D 41 52 4B     TYPE:      DB     'ARK'
0090: 0170 00          EXT:       DB     0
0091: 0171 00 00       RESV:      DB     0,0
0092: 0173 00          RC:        DB     0
0093: 0174 00 00       ALLOC:     DW     0
0094: 0176 00 00                  DW     0
0095: 0178 00 00                  DW     0
0096: 017A 00 00                  DW     0
0097: 017C 00 00                  DW     0
0098: 017E 00 00                  DW     0
0099: 0180 00 00                  DW     0
0100: 0182 00 00                  DW     0
0101: 0184 00          REC_SEQ:   DB     0
0102: 0185 00 00       REC_RANDOM: DW     0000H
0103: 0187 00          REC_RAN_O: DB     00
0104: 0188
0105: 0188
0106: 0188             erPermanent:
0107: 0188 00                     NOP
0108: 0189 76                     HALT
0109: 018A                        DS     0100H
0110: 028A 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00                DB     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
0111: 029A 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00                DB     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
0112: 02AA 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00                DB     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
0113: 02BA 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00                DB     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
0114: 02CA 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00                DB     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
0115: 02DA 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00                DB     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
0116: 02EA 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00                DB     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
0117: 02FA 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00                DB     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
0118: 030A             Stack:
0119: 030A
0120: 030A         ;DOLLARInclude ./HeaderForA.Z80
           ************************   Xref   ************************
0000: $               02FA   0074
0093: ALLOC           0174
0003: BDOS            0005
0074: builtInCMDCount 0006   0028
0067: builtInCMDNames 013E   0026 0074
0065: builtInCMDNameSize 0004   0027 0074
0076: builtInCMDVector 0156
0005: CLOSE_FILE      0010
0062: CMD             0139   0025
0013: defaultBuffer   0080
0087: DISK            0164
0106: erPermanent     0188
0090: EXT             0170
0085: FCB             0164
0006: FIND_FIRST      0011
0007: FIND_NEXT       0012
0054: Found           012E   0047
0011: GET_SIZE        0023
0030: Loop1           0111   0036
0043: Loop2           0120   0048
0039: Match           011D   0033
0088: NAME            0165
0004: OPEN_FILE       000F
0092: RC              0173
0008: READ_SEQ        0014
0103: REC_RAN_O       0187
0102: REC_RANDOM      0185
0101: REC_SEQ         0184
0015: recordRandom    0015   0016 0017 0018
0016: recordRandomLSB 0015
0017: recordRandomMSB 0016
0018: recordRandomOVF 0017
0009: RENAME_FILE     0017
0091: RESV            0171
0010: SET_DMA         001A
0012: SET_RANDREC     0024
0118: Stack           030A   0024
0023: Start           0100
0020: TPA             0100   0022
0089: TYPE            016D
0050: UserCommand     012C   0037 0058
