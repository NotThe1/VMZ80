0001: 0100         ;     File created by MakeZ80Source on Tue Sep 18 10:01:22 EDT 2018 from:
0002: 0100         ;     C:\Users\admin\Dropbox\Resources\CPM\CurrentOS\8080\BootSector.asm
0003: 0100         ; BootSector.Z80
0004: 0100         ; Build 2.01
0005: 0100
0006: 0100         ; 2019-03-02 Refactored constants and removed header files
0007: 0100         ; 2018-02-19 BDOS 1.0 designation
0008: 0100         ; 2018-11-22 begin  Z80 idiom update
0009: 0100         ; 2017-04-07 Added equates for message IO : BOOT_CON_ADDRESS
0010: 0100         ;				 , and default IOBYTE : IOBYTE_DEFAULT
0011: 0100         ; 2017-03-02 Refactored the CP/M Suite
0012: 0100
0013: 0100                        Include ./DCTheader.Z80
0014: 0100         ;<<<<<<<<<<<<<<<<<<<<<<< Include >>>>>>>>>>>>>>>>
0015: 0100         ; DCTheader.Z80
0016: 0100         ;
0017: 0100         ; Disk Control Block Header for CP/M
0018: 0100
0019: 0100
0020: 0100             DiskReadCode EQU    01H                  ; Code for Read
0021: 0100             diskSectorSize EQU    200H                 ; (512) size of physical disk I/O
0022: 0100             DiskControlTable EQU    0040H                ; Disk Control Table in Page 0
0023: 0100             DiskStatusLocation EQU    043H                 ; Status after disk I/O placed here
0024: 0100             DiskControlByte EQU    045H                 ; Control byte for disk I/O
0025: 0100             DiskCommandBlock EQU    046H                 ; Control Table Pointer
0026: 0100         ;<<<<<<<<<<<<<<<<<<<<<<< Include >>>>>>>>>>>>>>>>
0027: 0100                        Include ./osHeader.Z80
0028: 0100         ;<<<<<<<<<<<<<<<<<<<<<<< Include >>>>>>>>>>>>>>>>
0029: 0100         ;     File created by MakeZ80Source on Mon Sep 17 16:25:47 EDT 2018 from:
0030: 0100         ;     C:\Users\admin\Dropbox\Resources\CPM\CurrentOS\8080\osHeader.asm
0031: 0100         ; osHeader.Z80
0032: 0100
0033: 0100         ; 2018-12-28 Changed BDOSEntry to remove dead space in BDOS
0034: 0100         ; 2017-03-02 Refactored the CP/M Suite
0035: 0100
0036: 0100         ; Contains the Equates used by the CP/M system
0037: 0100
0038: 0100         ;------------------------Page Zero Constants ---------------------------------
0039: 0100             RAM        EQU    0                    ; Start of RAM ( and the Base page)
0040: 0100
0041: 0100             WarmBoot   EQU    RAM + 0              ; Contains a JMP instruction to warm boot in BIOS
0042: 0100             BIOSPAGE   EQU    RAM + 2              ; BIOS Jump Vector Page
0043: 0100             IOBYTE     EQU    RAM + 3              ; Input/Output redirection byte
0044: 0100
0045: 0100             Pg0CurentUser EQU    RAM + 4              ; Current user ( bits 7-4)
0046: 0100             Pg0CurentDisk EQU    Pg0CurentUser        ; Default logical disk (bits 0-3)
0047: 0100
0048: 0100             BDOSE      EQU    RAM + 5              ; Contains a JMP to BDOS entry
0049: 0100             TopRAM     EQU    BDOSE+2              ; Top page of usable RAM
0050: 0100
0051: 0100             FCB1       EQU    RAM + 05CH           ; File Control Block #1
0052: 0100             FCB2       EQU    FCB1 + 16            ; File Control Block #2
0053: 0100
0054: 0100             ComTail    EQU    RAM + 080H           ; Complete command tail
0055: 0100             ComTailCount EQU    ComTail              ; Count of the number of char in tail
0056: 0100             ComTailChars EQU    ComTailCount + 1     ; Complete Command tail up-cased, w/o trailing CR
0057: 0100         ;-----------------------------------------------------------------------
0058: 0100
0059: 0100             DMABuffer  EQU    RAM + 080H           ; Default "DMA" address used as buffer
0060: 0100         ;-----------------------------------------------------------------------
0061: 0100             TPA        EQU    RAM + 0100H          ; Start of Transient program Area
0062: 0100         ;-----------------------------------------------------------------------
0063: 0100             END_OF_FILE EQU    1AH                  ; end of file
0064: 0100         ;-----------------------------------------------------------------------
0065: 0100
0066: 0100         ;--------------- CP/M Constants -----------------------------------------
0067: 0100
0068: 0100             CCPLength  EQU    0800H                ; Constant
0069: 0100             BDOSLength EQU    0E00H                ; Constant 0E00H
0070: 0100             BIOSLength EQU    0A00H                ; Constant 0900H
0071: 0100
0072: 0100             LengthInBytes EQU    CCPLength + BDOSLength + BIOSLength
0073: 0100             LengthInK  EQU    (LengthInBytes/1024) + 1
0074: 0100
0075: 0100             MemorySize EQU    64
0076: 0100
0077: 0100             CCPEntry   EQU    (MemorySize * 1024) - LengthInBytes
0078: 0100
0079: 0100             BDOSBase   EQU    CCPEntry + CCPLength
0080: 0100             BDOSEntry  EQU    BDOSBase
0081: 0100
0082: 0100             BIOSBase   EQU    BDOSBase + BDOSLength
0083: 0100             BIOSStart  EQU    CCPEntry + CCPLength + BDOSLength
0084: 0100         ;-----------------------------------------------------------------------
0085: 0100
0086: 0100         ;? ;------------------- BDOS System Call Equates --------------------------
0087: 0100         ;? fConsoleIn			EQU		01H			; rcharf - Console Input
0088: 0100         ;? fConsoleOut			EQU		02H			; pcharf - Console Output
0089: 0100         ;? fPrintString		EQU		09H			; pbuff	- Print String
0090: 0100         ;? fReadString			EQU		0AH			; rbuff	- Read Console String
0091: 0100         ;? fGetConsoleStatus	EQU		0BH			; breakf - Get Console Status
0092: 0100         ;? fGetVersion			EQU		0CH			; liftf	- Return Version Number
0093: 0100         ;? fResetSystem		EQU		0DH			; initf	- Reset Disk System
0094: 0100         ;? fSelectDisk			EQU		0EH			; self	- Select Disk
0095: 0100         ;? fOpenFile			EQU		0FH			; openf	- Open File
0096: 0100         ;? fCloseFile			EQU		10H			; closef - Close File
0097: 0100         ;? fSearchFirst		EQU		11H			; searf	- Search For First
0098: 0100         ;? fSearchNext			EQU		12H			; searnf - Search for Next
0099: 0100         ;? fDeleteFile			EQU		13H			; delf - Delete File
0100: 0100         ;? fReadSeq			EQU		14H			; dreadf - Read Sequential
0101: 0100         ;? fWriteSeq			EQU		15H			; dwritf - Write Sequential
0102: 0100         ;? fMakeFile			EQU		16H			; makef	- Make File
0103: 0100         ;? fRenameFile			EQU		17H			; renf	- Rename File
0104: 0100         ;? fGetLoginVector		EQU		18H			; logf	- Return Login Vector
0105: 0100         ;? fGetCurrentDisk		EQU		19H			; cself	- Return Current Disk
0106: 0100         ;? fSetDMA				EQU		1AH			; dmaf	- Set DMA address
0107: 0100         ;? fGetSetUserNumber	EQU		20H			; userf	- Set/Get User Code
0108: 0100         ;? ;-----------------------------------------------------------------------
0109: 0100         ;?
0110: 0100         ;?
0111: 0100         ;?
0112: 0100         ;?
0113: 0100         ;?
0114: 0100         ;? ;*******************************************************************************
0115: 0100         ;? ; These are the values handed over by the BDOS when it calls the Writer operation
0116: 0100         ;? ; The allocated.unallocated indicates whether the BDOS is set to write to an
0117: 0100         ;? ; unallocated allocation block (it only indicates this for the first 128 byte
0118: 0100         ;? ; sector write) or to an allocation block that has already been allocated to a
0119: 0100         ;? ; file. The BDOS also indicates if it is set to write to the file directory
0120: 0100         ;? ;*******************************************************************************
0121: 0100         ;? WriteAllocated		EQU	00H
0122: 0100         ;? WriteDirectory		EQU	01H
0123: 0100         ;? WriteCleanBuffer	EQU	02H
0124: 0100
0125: 0100
0126: 0100         ;<<<<<<<<<<<<<<<<<<<<<<< Include >>>>>>>>>>>>>>>>
0127: 0100
0128: 0100             CR         EQU    0DH                  ; Carriage Return
0129: 0100             EOM        EQU    00H                  ; End Of Message
0130: 0100             LF         EQU    0AH                  ; Line Feed
0131: 0100
0132: 0100             CONSOLE    EQU    0ECH                 ; Console data address
0133: 0100             IOBYTE_DEFAULT EQU    080H                 ; LST:=LPT, rest all = TTY:
0134: 0100
0135: 0100             WarmBootEntry EQU    BIOSStart + 3
0136: 0100
0137: 0100                        ORG    TPA
0138: 0100             Start:
0139: 0100 31 FF 00               LD     SP,Start-1           ; Stack goes down from here
0140: 0103 CD F7 01               CALL   SendBootMessage      ; Display boot message
0141: 0106 01 3B 00               LD     BC,Page0ImageEnd-Page0Image ; Size of code to move
0142: 0109 21 3C 01               LD     HL,Page0Image        ; Source of page 0 code
0143: 010C 11 00 00               LD     DE,0000              ; Location 0, the target
0144: 010F
0145: 010F         ; Set up page zero,Move (B) bytes from (HL) to (DE).
0146: 010F ED B0                  LDIR                        ; Set up page 0
0147: 0111
0148: 0111         ; Now  start to move data to Disk Control Block
0149: 0111 21 2F 01               LD     HL,BootDiskControlTable ; Point at Boot's DCT
0150: 0114 22 46 00               LD     (DiskCommandBlock),HL ; Set up Command block for drive A:
0151: 0117 21 45 00               LD     HL,DiskControlByte
0152: 011A 36 80                  LD     (HL),080H            ; Activate the controller
0153: 011C
0154: 011C             WaitForBootComplete:
0155: 011C 7E                     LD     A,(HL)               ; Get the control byte
0156: 011D B7                     OR     A                    ; 0 = Completed operation
0157: 011E 20 FC                  JR     NZ,WaitForBootComplete ;  if not try again
0158: 0120
0159: 0120 3A 43 00               LD     A,(DiskStatusLocation) ; What's the status after operation
0160: 0123 FE 80                  CP     080H                 ; Any errors ?
0161: 0125 D2 00 00               JP     NC,0000              ; No, do a Warm Boot
0162: 0128
0163: 0128 21 CA 01               LD     HL,FailedBootMessage ;  else we have a problem
0164: 012B CD FA 01               CALL   SendMessage          ; Send message
0165: 012E 76                     HALT                        ; And STOP!
0166: 012F
0167: 012F         ;---------------------------- Boot Disk Control Block -----------------------;
0168: 012F             BootDiskControlTable:                      ;
0169: 012F 01                     DB     DiskReadCode         ; Read function                   	 ;
0170: 0130 00                     DB     00H                  ; unit number                     	 ;
0171: 0131 00                     DB     00H                  ; head number                     	 ;
0172: 0132 00                     DB     00H                  ; track number                    	 ;
0173: 0133 0D                     DB     0DH                  ; Starting sector number (13)     	 ;
0174: 0134 00 0A                  DW     5 * 512              ; Number of bytes to read         	 ;
0175: 0136         ;	( 0A00 All of BIOS)           	 ;
0176: 0136 00 F6                  DW     BIOSStart            ; read into this address          	 ;
0177: 0138 43 00                  DW     DiskStatusLocation   ; next block - no linking         	 ;
0178: 013A 40 00                  DW     DiskControlTable     ; next table- no linking          	 ;
0179: 013C         ;---------------------------- ROM Disk Control Block ------------------------;
0180: 013C
0181: 013C         ;------------------------------------ Page 0 --------------------------------;
0182: 013C             Page0Image:                      ;
0183: 013C C3 03 F6               JP     WarmBootEntry        ; warm start                         ;
0184: 013F         ;IOBYTE:                                                                     ;
0185: 013F 80                     DB     IOBYTE_DEFAULT       ; IOBYTE-                            ;
0186: 0140             DefaultDisk:                      ;
0187: 0140 00                     DB     00H                  ; Current default drive (A)          ;
0188: 0141 C3 00 E8               JP     BDOSEntry            ; jump to BDOS entry                 ;
0189: 0144                        DS     028H                 ; interrupt locations 1-5 not used   ;
0190: 016C                        DS     008H                 ; interrupt location 6 is reserved   ;
0191: 0174 C3 00 00               JP     0000H                ; RST 7 used only by DDT & SID       ;
0192: 0177             Page0ImageEnd:                      ;
0193: 0177         ;------------------------------------ Page 0 --------------------------------;
0194: 0177
0195: 0177         ;---------------------------------- Messages --------------------------------;
0196: 0177             BootMessage:                      ;
0197: 0177 0D 0A                  DB     CR,LF                ;
0198: 0179 42 6F 6F 74 53 74 72 61 70 20 6C 6F 61 64 65 72 20                DB     'BootStrap loader '  ;
0199: 018A 43 50 2F 4D 20 32 2E 32 20 28 5A 38 30 29 20                DB     'CP/M 2.2 (Z80) '    ;
0200: 0199 0D 0A                  DB     CR,LF                ;
0201: 019B 42 75 69 6C 64 20 31 2E 30 20                DB     'Build 1.0 '         ;
0202: 01A5 0D 0A                  DB     CR,LF                ;
0203: 01A7 43 43 50 20 31 2E 30 20 7C 20 20 42 44 4F 53 20 31 2E 30 20 7C 20 42 49 4F 53 20 31 2E 30                DB     'CCP 1.0 |  BDOS 1.0 | BIOS 1.0' ;
0204: 01C5 0D 0A 0D 0A 00                DB     CR,LF,CR,LF,EOM      ;
0205: 01CA         ;
0206: 01CA             FailedBootMessage:                      ;
0207: 01CA 0D 0A                  DB     CR,LF                ;
0208: 01CC 42 6F 6F 74 20 55 6E 73 75 63 63 65 73 73 66 75 6C 20 2D 20 43 68 65 63 6B 20 66 6F 72 20 44 69 73 6B 20 69 6E 20 41 3A                DB     'Boot Unsuccessful - Check for Disk in A:' ;
0209: 01F4 0D 0A 00                DB     CR,LF,EOM            ;
0210: 01F7         ;
0211: 01F7             SendBootMessage:                      ;
0212: 01F7 21 77 01               LD     HL,BootMessage       ;
0213: 01FA         ;
0214: 01FA             SendMessage:                      ;
0215: 01FA 7E                     LD     A,(HL)               ;
0216: 01FB B7                     OR     A                    ;
0217: 01FC C8                     RET    Z                    ;
0218: 01FD D3 EC                  OUT    (CONSOLE),A          ; Console address		             ;
0219: 01FF 23                     INC    HL                   ;
0220: 0200 C3 FA 01               JP     SendMessage          ;
0221: 0203         ;---------------------------------- Messages --------------------------------;
0222: 0203             Z_HighestLocation:
0223: 0203             Z_MemoryLeft EQU    0512H - Z_HighestLocation
           ************************   Xref   ************************
0000: $               0203
0079: BDOSBase        E800   0080 0082
0048: BDOSE           0005   0049
0080: BDOSEntry       E800   0188
0069: BDOSLength      0E00   0072 0082 0083
0082: BIOSBase        F600
0070: BIOSLength      0A00   0072
0042: BIOSPAGE        0002
0083: BIOSStart       F600   0135 0176
0168: BootDiskControlTable 012F   0149
0196: BootMessage     0177   0212
0077: CCPEntry        E000   0079 0083
0068: CCPLength       0800   0072 0079 0083
0054: ComTail         0080   0055
0056: ComTailChars    0081
0055: ComTailCount    0080   0056
0132: CONSOLE         00EC   0218
0128: CR              000D   0197 0200 0202 0204 0207 0209
0186: DefaultDisk     0140
0025: DiskCommandBlock 0046   0150
0024: DiskControlByte 0045   0151
0022: DiskControlTable 0040   0178
0020: DiskReadCode    0001   0169
0021: diskSectorSize  0200
0023: DiskStatusLocation 0043   0159 0177
0059: DMABuffer       0080
0063: END_OF_FILE     001A
0129: EOM             0000   0204 0209
0206: FailedBootMessage 01CA   0163
0051: FCB1            005C   0052
0052: FCB2            006C
0043: IOBYTE          0003
0133: IOBYTE_DEFAULT  0080   0185
0072: LengthInBytes   2000   0073 0077
0073: LengthInK       0009
0130: LF              000A   0197 0200 0202 0204 0207 0209
0075: MemorySize      0040   0077
0182: Page0Image      013C   0141 0142
0192: Page0ImageEnd   0177   0141
0046: Pg0CurentDisk   0004
0045: Pg0CurentUser   0004   0046
0039: RAM             0000   0041 0042 0043 0045 0048 0051 0054 0059 0061
0211: SendBootMessage 01F7   0140
0214: SendMessage     01FA   0164 0220
0138: Start           0100   0139
0049: TopRAM          0007
0061: TPA             0100   0137
0154: WaitForBootComplete 011C   0157
0041: WarmBoot        0000
0135: WarmBootEntry   F603   0183
0222: Z_HighestLocation 0203   0223
0223: Z_MemoryLeft    030F
