0001: 0000         ;     File created by MakeZ80Source on Tue Sep 18 10:06:02 EDT 2018 from:
0002: 0000         ;     C:\Users\admin\Dropbox\Resources\CPM\CurrentOS\8080\ROM.asm
0003: 0000         ; ROM.Z80
0004: 0000         ; Rom for BIOS set up for diskA to be 3.5HD (1.44MB) disk
0005: 0000
0006: 0000         ; 2019-03-02 Refactored constants and removed header files
0007: 0000         ; 2018-12-28 Adapted to also be used in BIOS Boot routine
0008: 0000         ; 2018-11-23 Moved code away from the DiskControlBlock
0009: 0000         ; 2018-11-22  Z80 idiom
0010: 0000         ; 2017-03-02 Refactored the CP/M Suite
0011: 0000
0012: 0000
0013: 0000                        Include ./DCTheader.Z80
0014: 0000         ;<<<<<<<<<<<<<<<<<<<<<<< Include >>>>>>>>>>>>>>>>
0015: 0000         ; DCTheader.Z80
0016: 0000         ;
0017: 0000         ; Disk Control Block Header for CP/M
0018: 0000
0019: 0000
0020: 0000             DiskReadCode EQU    01H                  ; Code for Read
0021: 0000             diskSectorSize EQU    200H                 ; (512) size of physical disk I/O
0022: 0000             DiskControlTable EQU    0040H                ; Disk Control Table in Page 0
0023: 0000             DiskStatusLocation EQU    043H                 ; Status after disk I/O placed here
0024: 0000             DiskControlByte EQU    045H                 ; Control byte for disk I/O
0025: 0000             DiskCommandBlock EQU    046H                 ; Control Table Pointer
0026: 0000         ;<<<<<<<<<<<<<<<<<<<<<<< Include >>>>>>>>>>>>>>>>
0027: 0000
0028: 0000             CR         EQU    0DH                  ; Carriage Return
0029: 0000             EOM        EQU    00H                  ; End Of Message
0030: 0000             LF         EQU    0AH                  ; Line Feed
0031: 0000             TPA        EQU    0100H                ; Transient Program Address
0032: 0000             CONSOLE    EQU    0ECH                 ; Console data address
0033: 0000
0034: 0000             DMABuffer  EQU    080H                 ; Default "DMA" address used as buffer
0035: 0000
0036: 0000                        ORG    0000
0037: 0000
0038: 0000             CodeStart:
0039: 0000 21 40 00               LD     HL,DiskControlTable  ; Point at ROM's DCT
0040: 0003 CD 0D 00               CALL   ReadRawDisk          ; Execute the disk read
0041: 0006 D2 00 01               JP     NC,TPA               ; Now execute the boot loader;
0042: 0009
0043: 0009 CD 80 00               CALL   NoDisk               ;						; Got here because no disk in drive
0044: 000C 76                     HALT                        ; STOP!
0045: 000D
0046: 000D             ReadRawDisk:                      ; Enter with DiskControlBlock pointer in HL
0047: 000D 22 46 00               LD     (DiskCommandBlock),HL ; put it into the Command block for drive A:
0048: 0010
0049: 0010 21 45 00               LD     HL,DiskControlByte   ; Point at Disk Control location
0050: 0013 36 80                  LD     (HL),080H            ; Activate the controller
0051: 0015
0052: 0015             WaitForBootComplete:
0053: 0015 7E                     LD     A,(HL)               ; Get the control byte
0054: 0016 B7                     OR     A                    ; Is it set to 0 (Completed operation) ?
0055: 0017 20 FC                  JR     NZ,WaitForBootComplete ; if not try again
0056: 0019
0057: 0019 3A 43 00               LD     A,(DiskStatusLocation) ; After operation what's the status?
0058: 001C FE 80                  CP     080H                 ; Any errors ?
0059: 001E C9                     RET                         ; Exit with result in the CCs
0060: 001F
0061: 001F         ;========================= ROM Disk Control Table ==========================;
0062: 001F                        ORG    DiskControlTable
0063: 0040         ;DiskControlTable:
0064: 0040 01                     DB     DiskReadCode         ; Read function
0065: 0041 00                     DB     00H                  ; unit number
0066: 0042 00                     DB     00H                  ; head number
0067: 0043 00                     DB     00H                  ; track number
0068: 0044 01                     DB     01H                  ; Starting sector number ()
0069: 0045 00 02                  DW     diskSectorSize       ; Number of bytes to read ( 1 Sector)
0070: 0047 00 01                  DW     TPA                  ; read into this address
0071: 0049 43 00                  DW     DiskStatusLocation   ; pointer to next block - no linking
0072: 004B 40 00                  DW     DiskControlTable     ; pointer to next table- no linking
0073: 004D
0074: 004D         ;=========================== Boot Failure Report ===========================;
0075: 004D                        ORG    DMABuffer
0076: 0080
0077: 0080             NoDisk:
0078: 0080 21 8B 00               LD     HL,NoDiskMessage     ; Load error message
0079: 0083             SendMessage:
0080: 0083 7E                     LD     A,(HL)               ; Get character
0081: 0084 B7                     OR     A                    ; Is it EOM ?
0082: 0085 C8                     RET    Z                    ;  if yes, exit
0083: 0086 D3 EC                  OUT    (CONSOLE),A          ; Send it to the Console
0084: 0088 23                     INC    HL                   ; Increment the pointer
0085: 0089 18 F8                  JR     SendMessage          ; Loop for more
0086: 008B
0087: 008B             NoDiskMessage:
0088: 008B 0D 0A                  DB     CR,LF
0089: 008D 4E 6F 20 53 79 73 74 65 6D 20 44 69 73 6B 20 4D 6F 75 6E 74 65 64                DB     'No System Disk Mounted'
0090: 00A3 0D 0A 00                DB     CR,LF,EOM
0091: 00A6
0092: 00A6             CodeEnd:
0093: 00A6
           ************************   Xref   ************************
0000: $               00A3
0092: CodeEnd         00A6
0038: CodeStart       0000
0032: CONSOLE         00EC   0083
0028: CR              000D   0088 0090
0025: DiskCommandBlock 0046   0047
0024: DiskControlByte 0045   0049
0022: DiskControlTable 0040   0039 0062 0072
0020: DiskReadCode    0001   0064
0021: diskSectorSize  0200   0069
0023: DiskStatusLocation 0043   0057 0071
0034: DMABuffer       0080   0075
0029: EOM             0000   0090
0030: LF              000A   0088 0090
0077: NoDisk          0080   0043
0087: NoDiskMessage   008B   0078
0046: ReadRawDisk     000D   0040
0079: SendMessage     0083   0085
0031: TPA             0100   0041 0070
0052: WaitForBootComplete 0015   0055
